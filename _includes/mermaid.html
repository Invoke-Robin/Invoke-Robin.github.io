<!-- _includes/mermaid.html -->
<script
  src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"
  defer
></script>
<script>
  (function () {
    // 0) Convert ```mermaid fences â†’ <div class="mermaid"> (both local & Pages)
    document.querySelectorAll("code.language-mermaid").forEach((code) => {
      const wrapper =
        code.closest("figure.highlight, pre, div.highlight") ||
        code.parentElement;
      const el = document.createElement("div");
      el.className = "mermaid";
      el.textContent = code.textContent;
      el.dataset.mmd = code.textContent;
      (wrapper || code).replaceWith(el);
    });
    document.querySelectorAll("div.mermaid").forEach((el) => {
      if (!el.dataset.mmd) el.dataset.mmd = el.textContent;
    });

    // Helper: read site colors so diagrams match theme
    const transparentRe =
      /rgba?\(\s*0\s*,\s*0\s*,\s*0\s*,\s*0\s*\)|^transparent$/i;
    const toRGB = (str) => {
      const probe = document.createElement("span");
      probe.style.color = str;
      document.body.appendChild(probe);
      const rgb = getComputedStyle(probe).color;
      probe.remove();
      const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      return m ? { r: +m[1], g: +m[2], b: +m[3] } : { r: 17, g: 17, b: 17 };
    };
    const mix = (a, b, t) => ({
      r: a.r * (1 - t) + b.r * t,
      g: a.g * (1 - t) + b.g * t,
      b: a.b * (1 - t) + b.b * t,
    });
    const effectiveBg = (el) => {
      let cur = el;
      while (cur) {
        const bg = getComputedStyle(cur).backgroundColor;
        if (bg && !transparentRe.test(bg)) return bg;
        cur = cur.parentElement;
      }
      return "#ffffff";
    };
    const detectColors = () => {
      const bodyCS = getComputedStyle(document.body);
      const text = bodyCS.color || "#111111";
      const bg = effectiveBg(document.body);
      const a = document.createElement("a");
      a.href = "#";
      a.style.display = "none";
      document.body.appendChild(a);
      const link = getComputedStyle(a).color;
      a.remove();

      const textRGB = toRGB(text),
        bgRGB = toRGB(bg),
        linkRGB = toRGB(link);
      const borderRGB = mix(textRGB, bgRGB, 0.4);
      const panelRGB = mix(bgRGB, textRGB, 0.06);
      return {
        text: `rgb(${textRGB.r}, ${textRGB.g}, ${textRGB.b})`,
        bg: `rgb(${bgRGB.r}, ${bgRGB.g}, ${bgRGB.b})`,
        border: `rgb(${borderRGB.r}, ${borderRGB.g}, ${borderRGB.b})`,
        panel: `rgb(${panelRGB.r}, ${panelRGB.g}, ${panelRGB.b})`,
        accent: `rgb(${linkRGB.r}, ${linkRGB.g}, ${linkRGB.b})`,
      };
    };

    const configFromPage = () => {
      const c = detectColors();
      return {
        startOnLoad: false,
        theme: "base",
        themeVariables: {
          background: c.bg,
          primaryTextColor: c.text,
          primaryBorderColor: c.border,
          lineColor: c.border,
          clusterBorder: c.border,
          clusterBkg: c.panel,
          primaryColor: c.panel,
          tertiaryColor: c.accent,
          edgeLabelBackground: c.bg,
        },
      };
    };

    function render() {
      if (!window.mermaid) return;
      document.querySelectorAll(".mermaid").forEach((el) => {
        if (el.dataset.mmd) el.textContent = el.dataset.mmd;
        el.removeAttribute("data-processed");
      });
      mermaid.initialize(configFromPage());
      mermaid.run({ querySelector: ".mermaid" });
    }

    // Defer until scripts/styles loaded
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", render, { once: true });
    } else {
      render();
    }

    // Rerender on color scheme / DOM changes
    const schedule = (() => {
      let t;
      return () => {
        clearTimeout(t);
        t = setTimeout(render, 120);
      };
    })();
    const mql = window.matchMedia?.("(prefers-color-scheme: dark)");
    if (mql)
      mql.addEventListener
        ? mql.addEventListener("change", schedule)
        : mql.addListener(schedule);
    new MutationObserver(schedule).observe(document.documentElement, {
      attributes: true,
      subtree: true,
      childList: true,
    });
    window.forceMermaidRerender = () => render();
  })();
</script>
<style>
  .mermaid {
    font-family: inherit;
  }
</style>
